<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Building a microservice in Clojure</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Building a microservice in Clojure</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_prerequisites">Prerequisites</a></li>
<li><a href="#_clojure_recap">Clojure recap</a></li>
<li><a href="#_create_application">Create application</a>
<ul class="sectlevel2">
<li><a href="#_exercise">Exercise</a></li>
</ul>
</li>
<li><a href="#_run_application">Run application</a>
<ul class="sectlevel2">
<li><a href="#_exercise_2">Exercise</a></li>
</ul>
</li>
<li><a href="#_ring">Ring</a>
<ul class="sectlevel2">
<li><a href="#_exercise_3">Exercise</a></li>
</ul>
</li>
<li><a href="#_hot_reload">Hot reload</a>
<ul class="sectlevel2">
<li><a href="#_exercise_4">Exercise</a></li>
</ul>
</li>
<li><a href="#_middleware">Middleware</a>
<ul class="sectlevel2">
<li><a href="#_exercise_5">Exercise</a></li>
</ul>
</li>
<li><a href="#_routing">Routing</a>
<ul class="sectlevel2">
<li><a href="#_exercise_6">Exercise</a></li>
</ul>
</li>
<li><a href="#_query_and_path_parameters">Query and path parameters</a>
<ul class="sectlevel2">
<li><a href="#_exercise_7">Exercise</a></li>
</ul>
</li>
<li><a href="#_json">JSON</a>
<ul class="sectlevel2">
<li><a href="#_exercise_8">Exercise</a></li>
</ul>
</li>
<li><a href="#_validation">Validation</a>
<ul class="sectlevel2">
<li><a href="#_exercises">Exercises</a></li>
</ul>
</li>
<li><a href="#_configuration">Configuration</a>
<ul class="sectlevel2">
<li><a href="#_exercises_2">Exercises</a></li>
</ul>
</li>
<li><a href="#_solutions">Solutions</a>
<ul class="sectlevel2">
<li><a href="#_create_application_2">Create application</a></li>
<li><a href="#_run_application_2">Run application</a></li>
<li><a href="#_ring_2">Ring</a></li>
<li><a href="#_hot_reload_2">Hot reload</a></li>
<li><a href="#_middleware_2">Middleware</a></li>
<li><a href="#_routing_2">Routing</a></li>
<li><a href="#_query_and_path_parameters_2">Query and path parameters</a></li>
<li><a href="#_json_2">JSON</a></li>
<li><a href="#_validation_2">Validation</a></li>
<li><a href="#_configuration_2">Configuration</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>JDK</p>
</li>
<li>
<p>Clojure - <a href="https://clojure.org" class="bare">https://clojure.org</a></p>
</li>
<li>
<p>Leiningen - <a href="https://leiningen.org" class="bare">https://leiningen.org</a> - ($ sdk install leiningen)</p>
</li>
<li>
<p>Cursive - <a href="https://cursive-ide.com" class="bare">https://cursive-ide.com</a> - Plugin for IntelliJ IDEA</p>
</li>
<li>
<p>(optional) Docker</p>
</li>
<li>
<p>(optional) Pack - <a href="https://buildpacks.io/docs/tools/pack/" class="bare">https://buildpacks.io/docs/tools/pack/</a></p>
</li>
<li>
<p>(optional) cURL of HTTPie - <a href="https://httpie.io" class="bare">https://httpie.io</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clojure_recap">Clojure recap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A short summary of Clojure characteristics needed to understand the workshop:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>(infix "notation")</p>
</li>
<li>
<p>Data structures</p>
<div class="ulist">
<ul>
<li>
<p>Map <code>{:a 1 :b 2 :c 3}</code></p>
</li>
<li>
<p>Vector <code>[a b c]</code></p>
</li>
<li>
<p>List <code>(a b c)</code></p>
</li>
<li>
<p>Set <code>#{a b c}</code></p>
</li>
</ul>
</div>
</li>
<li>
<p><code>map</code>, <code>filter</code>, <code>reduce</code>, <code>keyword</code> as function</p>
</li>
<li>
<p>Functions</p>
<div class="ulist">
<ul>
<li>
<p><code>(fn [value] (str value "ok"))</code></p>
</li>
<li>
<p><code>#(str % "ok"))</code></p>
</li>
<li>
<p><code>(defn ok [value] (str value "ok"))</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>REPL</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following snippet from the Clojure REPL shows the Clojure characteristics.
To try for yourself you can open a Clojure REPL by typing <code>$ clj</code> on the command-line.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w">
</span><span class="mi">16</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="no">:c</span><span class="w"> </span><span class="mi">3</span><span class="p">})</span><span class="w">
</span><span class="o">#</span><span class="ss">'user/m</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">m</span><span class="w">
</span><span class="p">{</span><span class="no">:a</span><span class="w"> </span><span class="mi">1</span><span class="n">,</span><span class="w"> </span><span class="no">:b</span><span class="w"> </span><span class="mi">2</span><span class="n">,</span><span class="w"> </span><span class="no">:c</span><span class="w"> </span><span class="mi">3</span><span class="p">}</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">[</span><span class="s">"a"</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="s">"c"</span><span class="p">])</span><span class="w">
</span><span class="o">#</span><span class="ss">'user/v</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">v</span><span class="w">
</span><span class="p">[</span><span class="s">"a"</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="s">"c"</span><span class="p">]</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">'</span><span class="p">(</span><span class="s">"a"</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="s">"c"</span><span class="p">))</span><span class="w">
</span><span class="o">#</span><span class="ss">'user/l</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">l</span><span class="w">
</span><span class="p">(</span><span class="s">"a"</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="s">"c"</span><span class="p">)</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">#</span><span class="p">{</span><span class="s">"a"</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="s">"c"</span><span class="p">})</span><span class="w">
</span><span class="o">#</span><span class="ss">'user/s</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="n">s</span><span class="w">
</span><span class="o">#</span><span class="p">{</span><span class="s">"a"</span><span class="w"> </span><span class="s">"b"</span><span class="w"> </span><span class="s">"c"</span><span class="p">}</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">.toUpperCase</span><span class="w"> </span><span class="n">c</span><span class="p">))</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="s">"A"</span><span class="w"> </span><span class="s">"B"</span><span class="w"> </span><span class="s">"C"</span><span class="p">)</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">.toUpperCase</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="s">"A"</span><span class="w"> </span><span class="s">"B"</span><span class="w"> </span><span class="s">"C"</span><span class="p">)</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">to-upper</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">.toUpperCase</span><span class="w"> </span><span class="n">c</span><span class="p">))</span><span class="w">
</span><span class="o">#</span><span class="ss">'user/to-upper</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="n">to-upper</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="s">"A"</span><span class="w"> </span><span class="s">"B"</span><span class="w"> </span><span class="s">"C"</span><span class="p">)</span><span class="w">
</span><span class="n">user=&gt;</span><span class="w"> </span><span class="p">(</span><span class="no">:b</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w">
</span><span class="mi">2</span><span class="w">
</span><span class="n">user=&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_application">Create application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We use Leiningen as build tool for our Clojure project.
The Leiningen <code>new</code> command takes as first argument the name of a project template and then the project name.
We use the <code>app</code> project template, because it contains some useful default to run our application with Java.
The name of our service is <code>sample-service</code>.</p>
</div>
<div class="paragraph">
<p>In the following sample we see the necessary Leiningen commands:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein new app sample-service</pre>
</div>
</div>
<div class="paragraph">
<p>Next we can open the project in IntelliJ (make sure the Cursive plugin is installed).</p>
</div>
<div class="paragraph">
<p>Right click on the file <code>project.clj</code> and select <em>Run REPL</em></p>
</div>
<div class="sect2">
<h3 id="_exercise">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Create a new app with Leiningen using the <code>app</code> project template.</p>
</li>
<li>
<p>Run REPL for the project in IntelliJ with Cursive.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_run_application">Run application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can run our application from IntelliJ by simply clicking in the gutter on the green icon for the <code>(-main)</code> function.</p>
</div>
<div class="paragraph">
<p>We can also use Leiningen with the <code>run</code> command.</p>
</div>
<div class="paragraph">
<p>Alternative is to create a JAR with Leiningine command <code>uberjar</code> and use <code>java -jar</code> to run the application.</p>
</div>
<div class="paragraph">
<p>Several ways to run in Docker.
Easiest is to have JAR and copy in Dockerfile or use Pack.</p>
</div>
<div class="sect2">
<h3 id="_exercise_2">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Run the app from IntelliJ</p>
</li>
<li>
<p>Use lein run/jar/uberjar</p>
</li>
<li>
<p>Change uberjar name</p>
</li>
<li>
<p>Use java -jar to run</p>
</li>
<li>
<p>(optional) Use pack to build Docker image</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ring">Ring</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/ring-clojure/ring/wiki/Concepts" class="bare">https://github.com/ring-clojure/ring/wiki/Concepts</a></p>
</div>
<div class="sect2">
<h3 id="_exercise_3">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Add ring dependencies in <code>project.clj</code>.</p>
</li>
<li>
<p>Add to <code>ns</code> a <code>(:require [ring.adapter.jettty :refer [run-jetty]])</code>.</p>
</li>
<li>
<p>Add a new function <code>start-server</code> to invoke <code>run-jetty</code> function with options <code>{:join? false}</code>.</p>
</li>
<li>
<p>Add new function <code>hello-world-handler</code> with single argument and return map with <code>:status</code>, <code>:headers</code>, <code>:body</code>.</p>
</li>
<li>
<p>Use function <code>start-server</code> from <code>-main</code>.</p>
</li>
<li>
<p>Start with <code>lein run</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hot_reload">Hot reload</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To have a better development experience we can use the REPL to start and stop our Jetty server.
We can also invoke the handler functions directly from the REPL to see response maps.
Later we will see how we can provide a request map to even have middleware and routing applied.</p>
</div>
<div class="paragraph">
<p>Instead of the REPL we can also use the <a href="https://github.com/weavejester/lein-ring">Leiningen Ring plugin</a> to hot reload our main handler.
With this setup we can change the source file, save it and access the endpoint via our browser or using command-line tools and the changes are immediattely visible.
With the commmand <code>lein ring server</code> a new server is started on port 3000 (we can define a new port by adding the required port on the command-line, e.g. <code>lein ring server 4000</code>).
This starts also a web browser, if we don&#8217;t want a web browser we use <code>lein run server-headless</code>.</p>
</div>
<div class="sect2">
<h3 id="_exercise_4">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Use lein-ring plugin by adding to <code>project.clj</code> in new key <code>:plugins</code> with <code>[[lein-ring "0.12.5"]]</code> and add a new key <code>:ring {:handler sample-service.core/hello-world-handler}</code>.</p>
</li>
<li>
<p>Run <code>$ lein ring server</code> or <code>server-headless</code>, make changes to the handler and check hot reloading.</p>
</li>
<li>
<p>Stop lein ring server.</p>
</li>
<li>
<p>In REPL use <code>(def jetty (start-server))</code> to start Jetty</p>
</li>
<li>
<p>And <code>(.stop jetty)</code> to stop</p>
</li>
<li>
<p>Add as <code>(comment &#8230;&#8203;. )</code> at the end of <code>core.clj</code> and use <em>Shift+Cmd+P</em> to send to REPL</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_middleware">Middleware</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An import element from Ring is middleware.
Middleware are functions that wrap around handlers and can for example make choices based on contents in the request map, changes responses, add authentication and much more.</p>
</div>
<div class="sect2">
<h3 id="_exercise_5">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Add a function as middleware to add <code>:clojure-version</code> key to request map.</p>
</li>
<li>
<p>Use middleware around <code>hello-world-handler</code>.</p>
</li>
<li>
<p>Use <code>:clojure-version</code> in <code>hello-world-handler</code>.</p>
</li>
<li>
<p>Create new <code>app</code> variable <code>(def app &#8230;&#8203;)</code>.</p>
</li>
<li>
<p>Include standard middleware from ring-defaults.</p>
</li>
<li>
<p>Use <code>&#8594;</code> (thread first macro) to combine multiple middleware.</p>
</li>
<li>
<p>Use <code>response</code> function from <code>ring.util.response</code> instead of map for <code>hello-world-handler</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_routing">Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nice to have a single handler with Ring in our application, but we want to support some more endpoints.
We need routing and a very common library for Clojure applications is <a href="https://github.com/weavejester/compojure">Compojure</a>.
With Compojure we can create routes using the function <code>routes</code> or the macro <code>defroutes</code>.
The result is a handler with functionality to dispatch to functions based on for example the request method.
Because the result is still a handler it can easily be applied in a Ring based application.</p>
</div>
<div class="sect2">
<h3 id="_exercise_6">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Add Compojure dependency.</p>
</li>
<li>
<p>Add <code>compojure.core</code> referencing <code>GET</code>, <code>routes</code>, <code>defroutes</code> to <code>:require</code> in <code>core.clj</code>.</p>
</li>
<li>
<p>Define routes for <code>GET /</code> to use hello world handler.</p>
</li>
<li>
<p>Define route for <code>GET /request</code> with handler to return the request map in the response.</p>
</li>
<li>
<p>Add fallback route to return 404 when no match can be found using <code>compojure.route.notfound</code> function.</p>
</li>
<li>
<p>Use route in <code>app</code> variable.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_and_path_parameters">Query and path parameters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have some simple handlers that don&#8217;t need values from request or path parameters.
To support query and path parameters Compojure uses destructurizing from the request map <code>:params</code> key.
When we define an route function we can define the query parameter names as arguments.
If we still want access to the original request we can use <code>:as request</code> so we have both query parameters and the original request if needed.</p>
</div>
<div class="sect2">
<h3 id="_exercise_7">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Add new endpoint <code>GET "/hello"</code> and use query-parameter <code>name</code> to return response with <code>name</code> value.</p>
</li>
<li>
<p>Add new endpoint for <code>GET "/hello/:name</code> with path-parameter <code>name</code> and return response with <code>name</code> value.</p>
</li>
<li>
<p>Support optional query-parameter <code>greeting</code> for both endpoints.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_json">JSON</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To support JSON we can use a library to manually transform data structures to JSON, but we can also use middleware that does all the work for us.
We use <a href="https://github.com/ring-clojure/ring-json">Ring JSON</a> for our exercises, but there are more libraries to support JSON.</p>
</div>
<div class="sect2">
<h3 id="_exercise_8">Exercise</h3>
<div class="ulist">
<ul>
<li>
<p>Add endpoint <code>GET "/collection"</code> to return a colletion data structure (e.g. map) as JSON.</p>
</li>
<li>
<p>Add new middleware <code>wrap-json-response</code> to have JSON output.</p>
</li>
<li>
<p>Add new endpont <code>POST "/hello</code> and support JSON body <code>{"name":"JDriven","greeting":"Hi"}</code>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation">Validation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clojure can support data validation via schemas.
There is schema support in <code>clojure.spec</code>, but we will use a third-party library <a href="https://github.com/plumatic/schema">Schema</a>.
We can define a data format for a map and with the <code>validate</code> and <code>check</code> functions we can validate if the map complies with the defined data format.</p>
</div>
<div class="sect2">
<h3 id="_exercises">Exercises</h3>
<div class="ulist">
<ul>
<li>
<p>Add Prismatic Schema dependency to project and <code>[schema.core :as s]</code> to <code>:require</code> in <code>core.clj</code>.</p>
</li>
<li>
<p>Define <code>HelloRequest</code> with a required <code>name</code> key of type String and optional key <code>greeting</code> of type String.</p>
</li>
<li>
<p>Create new <code>validate-hello-handler</code> with <code>request</code> parameter and use <code>HelloRequest</code> to validate. Return a 400 response when the data is not valid and call <code>hello-handler</code> when the data is valid.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration">Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/weavejester/environ">Environ</a> a library for reading environment settings from different sources.
Sources can be system environment variables, Java system properties or configuration files.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
When we use port 0 a random port is used by Jetty.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_exercises_2">Exercises</h3>
<div class="ulist">
<ul>
<li>
<p>Add <code>:port</code> configuration property to <code>run-jetty</code> with value 0 and check that random port is used.</p>
</li>
<li>
<p>Use a fixed value in the configuration property and check that value is used.</p>
</li>
<li>
<p>Implement port read from <code>System/getenv</code> and fallback to default.</p>
</li>
<li>
<p>Add environ dependency and use it to set port number.</p>
</li>
<li>
<p>Check different ways to set port (environment variable, System property, config file).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solutions">Solutions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_create_application_2">Create application</h3>
<div class="paragraph">
<p>From the command-line we type</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein new app sample-service</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
It is important to use exactly this command as it uses the <em>app</em> Leiningen template to set already some useful defaults for our application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start the REPL by right-clicking on <code>project.clj</code> and select <em>Run REPL</em>.</p>
</div>
<div class="paragraph">
<p>If the REPL is not opened it is good to check that project has a JDK configured.</p>
</div>
<div class="paragraph">
<p>In the REPL type <code>(-main)</code> followed by <em>Cmd+Enter</em></p>
</div>
<div class="paragraph">
<p>Change code in <code>core.clj</code>, reload file (<em>Shift+Cmd+L</em>)</p>
</div>
<div class="paragraph">
<p>Execute <code>(-main)</code></p>
</div>
<div class="paragraph">
<p>Use <em>Shift+Cmd+P</em> to send function in editor to REPL.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_application_2">Run application</h3>
<div class="paragraph">
<p>In IntelliJ run (-main) by clicking on the green arrow icon in the gutter for the <code>(-main)</code> function in <code>core.clj</code>.</p>
</div>
<div class="paragraph">
<p>Run with Leiningen:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein run</pre>
</div>
</div>
<div class="paragraph">
<p>Create a simple JAR with only the application code:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein jar</pre>
</div>
</div>
<div class="paragraph">
<p>Create a JAR with all dependencies included and configured to run <code>(-main)</code> function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein uberjar
$ java -jar target/uberjar/sample-service-0.1.0-SNAPSHOT-standalone.jar</pre>
</div>
</div>
<div class="paragraph">
<p>To use a different name for the generated JAR file by the <code>uberjar</code> task we must add a new key in <code>project.clj</code>:
  <code>:uberjar-name "sample-service.jar"</code></p>
</div>
<div class="paragraph">
<p>The JAR file can be copied to a Docker image, but we can also use Pack.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ pack set-default-builder  paketobuildpacks/builder:base
$ pack build sample-service --path target/uberjar/sample-service.jar
$ docker run sample-service</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ring_2">Ring</h3>
<div class="paragraph">
<p>First we need to add dependencies to our project.
In <code>project.clj</code> we must new dependencies to the <code>:dependencies</code> key:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ring "1.8.2"]
[ring/ring-defaults "0.3.2"]
[ring/ring-json "0.5.0"]</pre>
</div>
</div>
<div class="paragraph">
<p>In IntelliJ we can refresh the Leiningen project so all dependencies are loaded.
It is also good to restart the REPL if it was started.</p>
</div>
<div class="paragraph">
<p>Next we must add the <code>run-jetty</code> function from the <code>ring.adapter.jetty</code> namespace.
We open <code>core.clj</code> and in the <code>ns</code> function we add:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(:require [ring.adapter.jetty :refer [run-jetty]])</pre>
</div>
</div>
<div class="paragraph">
<p>In <code>core.clj</code> we add the following function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-server</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">run-jetty</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w"> </span><span class="p">{</span><span class="no">:join?</span><span class="w"> </span><span class="n">false</span><span class="p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also add the function <code>hello-world-handler</code>.
Make sure the function is defined above the function <code>start-server</code> in the source file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w">
  </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">{</span><span class="no">:status</span><span class="w"> </span><span class="mi">200</span><span class="w">
   </span><span class="no">:headers</span><span class="w"> </span><span class="p">{</span><span class="s">"Content-Type"</span><span class="w"> </span><span class="s">"text/plain"</span><span class="p">}</span><span class="w">
   </span><span class="no">:body</span><span class="w"> </span><span class="s">"Hello world from Ring!"</span><span class="p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we add the call to this function in the <code>(-main)</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">-main</span><span class="w">
  </span><span class="s">"I don't do a whole lot ... yet."</span><span class="w">
  </span><span class="p">[</span><span class="o">&amp;</span><span class="w"> </span><span class="n">args</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">start-server</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From the command-line we invoke</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein run</pre>
</div>
</div>
<div class="paragraph">
<p>This will start Jetty as web server on port 80.
We can access <a href="http://localhost" class="bare">http://localhost</a> in our browser and it should show the text "Hello world from Ring!".</p>
</div>
<div class="paragraph">
<p>If port 80 cannot be used, we can define a custom port in the <code>start-server</code> function.
In the options map we add the key <code>:port</code> followed by a port number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-server</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">run-jetty</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w"> </span><span class="p">{</span><span class="no">:join?</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="no">:port</span><span class="w"> </span><span class="mi">8080</span><span class="p">}))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hot_reload_2">Hot reload</h3>
<div class="paragraph">
<p>First we add the Ring plugin to our <code>project.clj</code> with the correct configuration:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>:plugins [[lein-ring "0.12.5"]]
:ring {:handler sample-service.core/hello-world-handler}</pre>
</div>
</div>
<div class="paragraph">
<p>We can now use <code>$ lein run server</code> or <code>$ lein run server-headless</code> to start the server.
Let&#8217;s make a change in the handler in <code>core.clj</code> and save the file.
Access the root of our server again and see the changes.</p>
</div>
<div class="paragraph">
<p>To run our server in the REPL and handle it from there we must create a new variable with the result of the <code>start-server</code> function.
The variable stores the Jetty server and we can invoke the <code>.stop</code> function on this variable.
This is Java interop from Clojure, because the method <code>stop</code> is then invoked.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">jetty</span><span class="w"> </span><span class="p">(</span><span class="nf">start-server</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">.stop</span><span class="w"> </span><span class="n">jetty</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To save this so we can use the command from our source file and send them to the REPL using <em>Cmd+Shift+P</em> we add the function calls to a <code>comment</code> function in <code>core.clj</code>.
This way the code is not executed, but easy accessible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nb">comment</span><span class="w">
  </span><span class="c1">;; Stop server</span><span class="w">
  </span><span class="p">(</span><span class="nf">.stop</span><span class="w"> </span><span class="n">jetty</span><span class="p">)</span><span class="w">
  </span><span class="c1">;; Start server</span><span class="w">
  </span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">jetty</span><span class="w"> </span><span class="p">(</span><span class="nf">start-server</span><span class="p">))</span><span class="w">
  </span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_middleware_2">Middleware</h3>
<div class="paragraph">
<p>We create a new function that will add the key <code>:clojure-version</code> to the request map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">wrap-clojure-version</span><span class="w">
  </span><span class="p">[</span><span class="n">handler</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">handler</span><span class="w"> </span><span class="p">(</span><span class="nf">assoc-in</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="p">[</span><span class="no">:clojure-version</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure-version</span><span class="p">)))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we must wrap our <code>hello-world-handler</code> in this wrapper function and we assign to a new variable <code>app</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="p">(</span><span class="nf">wrap-clojure-version</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We also add some middleware from a library.
In our source file <code>core.clj</code> we add to the <code>:require</code> attributes the following:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ring.middleware.defaults :refer [wrap-defaults api-defaults site-defaults]]</pre>
</div>
</div>
<div class="paragraph">
<p>We can use the thread-first macro which is useful when function calls are chained.
When the output of a function is the first argument of a new function we can use <code>&#8594;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w">
             </span><span class="n">wrap-clojure-version</span><span class="w">
             </span><span class="p">(</span><span class="nf">wrap-defaults</span><span class="w"> </span><span class="n">api-defaults</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can replace <code>api-defaults</code> with <code>site-defaults</code> and can check the handler output to see that different response headers are returned.</p>
</div>
<div class="paragraph">
<p>In our source file <code>core.clj</code> we add to the <code>:require</code> section the following so we can use the <code>response</code> function.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ring.util.response :refer [response]]</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>response</code> function creates a response map with some defaults and we only have to specify the body we want in the response as argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w">
  </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">response</span><span class="w"> </span><span class="s">"Hello world from Ring!"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Testing our application can be done from the REPL as well.
We can create a request map by hand and pass it as argument to <code>app</code>:`(app {:request-method :get :uri "/hello"})`.
The output of the function is the complete response map with all middleware applied.
(There is also a ring/mock library with mock function to create request maps we could add to our project and use in the REPL).
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_routing_2">Routing</h3>
<div class="paragraph">
<p>First we need to add dependencies to our project.
In <code>project.clj</code> we must new dependencies to the <code>:dependencies</code> key:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[compojure "1.6.2"]</pre>
</div>
</div>
<div class="paragraph">
<p>In IntelliJ we can refresh the Leiningen project so all dependencies are loaded.
It is also good to restart the REPL if it was started.</p>
</div>
<div class="paragraph">
<p>In the <code>:require</code> reference we add</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[compojure.core :refer [routes defroutes GET POST]]</pre>
</div>
</div>
<div class="paragraph">
<p>In <code>core.clj</code> we use the <code>defroutes</code> macro to define a route with the name <code>api</code> and map <code>GET /</code> to our <code>hello-world-handler</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">defroutes</span><span class="w"> </span><span class="n">api</span><span class="w">
           </span><span class="p">(</span><span class="nf">GET</span><span class="w"> </span><span class="s">"/"</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="p">))</span><span class="w">

</span><span class="c1">;; Alternative using routes function instead of defroutes macro</span><span class="w">
</span><span class="c1">;; (def api</span><span class="w">
</span><span class="c1">;;   (routes</span><span class="w">
</span><span class="c1">;;     (GET "/" [] hello-world-handler)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a new handler that returns the request map in the response we can define in <code>core.clj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">request-handler</span><span class="w">
  </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">response</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">request</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And add a new route to our <code>api</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">defroutes</span><span class="w"> </span><span class="n">api</span><span class="w">
           </span><span class="p">(</span><span class="nf">GET</span><span class="w"> </span><span class="s">"/"</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="p">)</span><span class="w">
           </span><span class="p">(</span><span class="nf">GET</span><span class="w"> </span><span class="s">"/request"</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">request-handler</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To be complete we can add a fallback if no routing can be found that will return a nice 404 response.
First we add the <code>:require</code> section:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[compojure.route :refer [not-found]]</pre>
</div>
</div>
<div class="paragraph">
<p>And in <code>core.clj</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="nf">defroutes</span><span class="w"> </span><span class="n">api</span><span class="w">
           </span><span class="p">(</span><span class="nf">GET</span><span class="w"> </span><span class="s">"/"</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="p">)</span><span class="w">
           </span><span class="p">(</span><span class="nf">GET</span><span class="w"> </span><span class="s">"/request"</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">request-handler</span><span class="p">)</span><span class="w">
           </span><span class="p">(</span><span class="nf">not-found</span><span class="w"> </span><span class="s">"You have reached the end of the internet"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we must not forgt to use <code>api</code> instead of <code>hello-world-handler</code> as our main handler for the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="k">def</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">api</span><span class="w">
            </span><span class="n">wrap-clojure-version</span><span class="w">
            </span><span class="p">(</span><span class="nf">wrap-defaults</span><span class="w"> </span><span class="n">api-defaults</span><span class="p">)))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_query_and_path_parameters_2">Query and path parameters</h3>
<div class="paragraph">
<p>First we create a new handler <code>hello-handler</code> that returns a string value with the value of the <code>name</code> parameter.
We simplify the response to only a string and Compojure&#8217;s route function will make sure it is a response map.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">hello-handler</span><span class="w">
  </span><span class="p">[</span><span class="nb">name</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="s">"Hello "</span><span class="w"> </span><span class="nb">name</span><span class="w"> </span><span class="s">"!"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We add a new route to our <code>api</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(GET "/hello" [name] (hello-handler name))</pre>
</div>
</div>
<div class="paragraph">
<p>This can be tested using <code>/hello?name=JDriven</code>.</p>
</div>
<div class="paragraph">
<p>We can re-use our <code>hello-handler</code> function in a route with a path parameter <code>name</code>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(GET "/hello/:name" [name] (hello-handler name))</pre>
</div>
</div>
<div class="paragraph">
<p>This can be tested using <code>/hello/JDriven</code>.</p>
</div>
<div class="paragraph">
<p>To support an optional greeting we rewrite the <code>hello-handler</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">hello-handler</span><span class="w">
  </span><span class="p">[</span><span class="n">greeting</span><span class="w"> </span><span class="nb">name</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="n">greeting</span><span class="w"> </span><span class="s">"Hello"</span><span class="p">)</span><span class="w"> </span><span class="s">" "</span><span class="w"> </span><span class="nb">name</span><span class="w"> </span><span class="s">"!"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we change our routes and add the <code>greeting</code> parameter:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(GET "/hello" [name greeting] (hello-handler greeting name))
(GET "/hello/:name" [name greeting] (hello-handler greeting name))</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_json_2">JSON</h3>
<div class="paragraph">
<p>In the <code>core.clj</code> file we add the new function <code>coll-handler</code> that will be invoked for the route <code>GET "/collection"</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">coll-handler</span><span class="w">
  </span><span class="p">[</span><span class="n">coll</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">response</span><span class="w"> </span><span class="n">coll</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <code>api</code> routes definition we add the following function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(GET "/collection" [] (coll-handler {:a 1 :b 2 :c 3}))</pre>
</div>
</div>
<div class="paragraph">
<p>When we invoke the endpoint we get an error.
We still need to add middleware to convert our map to a JSON reponse.
In the <code>:require</code> function in the <code>ns</code> function we add:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ring.middleware.json :refer [wrap-json-response]]</pre>
</div>
</div>
<div class="paragraph">
<p>And we add it to our list of middleware:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">api</span><span class="w">
             </span><span class="n">wrap-json-response</span><span class="w">
             </span><span class="n">wrap-clojure-version</span><span class="w">
             </span><span class="p">(</span><span class="nf">wrap-defaults</span><span class="w"> </span><span class="n">api-defaults</span><span class="p">)))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can check the endpoint again and see we have a JSON response.</p>
</div>
<div class="paragraph">
<p>Next we want support a POST request to the <code>/hello</code> endpoint with JSON request body containing the keys <code>name</code> and <code>greeting</code>.
Therefore we can re-use our <code>hello-handler</code> and with the help of middleware our JSON request body will be converted to a Clojure map in the <code>:params</code> key of the request map.</p>
</div>
<div class="paragraph">
<p>First we add the function to define our new route in the <code>api</code> routes definition:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(POST "/hello" [name greeting] (hello-handler greeting name))</pre>
</div>
</div>
<div class="paragraph">
<p>We add references to the middleware functions in the <code>:require</code> function in the <code>ns</code> function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[ring.middleware.json :refer [wrap-json-response wrap-json-params wrap-json-body]]
[ring.middleware.keyword-params :refer [wrap-keyword-params]</pre>
</div>
</div>
<div class="paragraph">
<p>Finally we apply the new middleware functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="n">api</span><span class="w">
             </span><span class="n">wrap-keyword-params</span><span class="w">
             </span><span class="n">wrap-json-params</span><span class="w">
             </span><span class="n">wrap-json-response</span><span class="w">
             </span><span class="n">wrap-clojure-version</span><span class="w">
             </span><span class="p">(</span><span class="nf">wrap-defaults</span><span class="w"> </span><span class="n">api-defaults</span><span class="p">)))</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validation_2">Validation</h3>
<div class="paragraph">
<p>First we need to add dependencies to our project.
In <code>project.clj</code> we must new dependencies to the <code>:dependencies</code> key:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[prismatic/schema "1.1.3"]</pre>
</div>
</div>
<div class="paragraph">
<p>In IntelliJ we can refresh the Leiningen project so all dependencies are loaded.
It is also good to restart the REPL if it was started.</p>
</div>
<div class="paragraph">
<p>In the <code>:require</code> reference we add</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[schema.core :as s]</pre>
</div>
</div>
<div class="paragraph">
<p>Using <code>:as</code> we can use all function from the namespace by prefixing the function with <code>s/</code>.</p>
</div>
<div class="paragraph">
<p>First we need to define our data structure where we define a <code>:name</code> key and optional <code>:greeting</code> key in our request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">HelloRequest</span><span class="w">
  </span><span class="p">{</span><span class="no">:name</span><span class="w">                      </span><span class="n">s/Str</span><span class="w">
   </span><span class="p">(</span><span class="nf">s/optional-key</span><span class="w"> </span><span class="no">:greeting</span><span class="p">)</span><span class="w"> </span><span class="n">s/Str</span><span class="p">})</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create a new function <code>validate-hello-handler</code> where we can validate the input and return a 400 response (bad request) when the data is not correct.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">validate-hello-handler</span><span class="w">
  </span><span class="p">[</span><span class="n">request</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">input</span><span class="w"> </span><span class="p">(</span><span class="no">:params</span><span class="w"> </span><span class="n">request</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">if-let</span><span class="w"> </span><span class="p">[</span><span class="n">error</span><span class="w"> </span><span class="p">(</span><span class="nf">s/check</span><span class="w"> </span><span class="n">HelloRequest</span><span class="w"> </span><span class="n">input</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="nf">bad-request</span><span class="w"> </span><span class="p">(</span><span class="nb">str</span><span class="w"> </span><span class="n">error</span><span class="p">))</span><span class="w">
      </span><span class="p">(</span><span class="nf">hello-handler</span><span class="w"> </span><span class="p">(</span><span class="no">:greeting</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:name</span><span class="w"> </span><span class="n">input</span><span class="p">)))))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In our <code>api</code> definition we add a new route function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>(POST "/hello" [] validate-hello-handler)</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2">Configuration</h3>
<div class="paragraph">
<p>In the file <code>core.clj</code> we change the <code>start-server</code> function.
In the options map we add the option <code>:port</code> with value <code>0</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-server</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">run-jetty</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w"> </span><span class="p">{</span><span class="no">:join?</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="no">:port</span><span class="w"> </span><span class="mi">0</span><span class="p">}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>From the command-line we can run the server and it is started on a random port.
In the output when the server is started we can see which port is used:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ lein run</pre>
</div>
</div>
<div class="paragraph">
<p>We can change the value <code>0</code> and set it to <code>8080</code>.
Next we start the server and now the server is started on port <code>8080</code>.</p>
</div>
<div class="paragraph">
<p>Instead of the fixed port we want to use the value of the environment variable <code>PORT</code>.
In Clojure we can use the <code>getenv</code> method from <code>java.lang.System</code> as function with <code>System/getenv</code>.
The returned value is a string value we must convert to <code>Integer</code> with <code>Integer/parseInt</code>.
The value <code>8080</code> is a fallback value and we can use the <code>or</code> function.
The <code>or</code> function will return the first non-false value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-server</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">run-jetty</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w"> </span><span class="p">{</span><span class="no">:join?</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="no">:port</span><span class="w"> </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="p">(</span><span class="nf">System/getenv</span><span class="w"> </span><span class="s">"PORT"</span><span class="p">)</span><span class="w"> </span><span class="mi">8080</span><span class="p">)}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to add dependencies to Environ to our project.
In <code>project.clj</code> we must new dependencies to the <code>:dependencies</code> key:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[environ "1.2.0"]</pre>
</div>
</div>
<div class="paragraph">
<p>In IntelliJ we can refresh the Leiningen project so all dependencies are loaded.
It is also good to restart the REPL if it was started.</p>
</div>
<div class="paragraph">
<p>Next we must add the <code>run-jetty</code> function from the <code>ring.adapter.jetty</code> namespace.
We open <code>core.clj</code> and in the <code>ns</code> function we add to the <code>:require</code> function:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[environ.core :refer [env]]</pre>
</div>
</div>
<div class="paragraph">
<p>Then we can use the <code>env</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">start-server</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">run-jetty</span><span class="w"> </span><span class="n">hello-world-handler</span><span class="w"> </span><span class="p">{</span><span class="no">:join?</span><span class="w"> </span><span class="n">false</span><span class="w"> </span><span class="no">:port</span><span class="w"> </span><span class="p">(</span><span class="nf">Integer/parseInt</span><span class="w"> </span><span class="p">(</span><span class="no">:port</span><span class="w"> </span><span class="n">env</span><span class="p">)</span><span class="w"> </span><span class="mi">8080</span><span class="p">)}))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we create a file <code>.lein-env</code> in our project root directory with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="clojure"><span class="p">{</span><span class="no">:port</span><span class="w"> </span><span class="mi">8080</span><span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-02-04 11:17:46 +0100
</div>
</div>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</body>
</html>